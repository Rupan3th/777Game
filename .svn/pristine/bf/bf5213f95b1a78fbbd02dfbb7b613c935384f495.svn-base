using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using MySql.Data.MySqlClient;
using System.Data.Sql;
using System.Data.SqlClient;
using System.Configuration;

public partial class houtai_game_Default : System.Web.UI.Page
{
    mysql mconn = new mysql();
    mysql mconn1 = new mysql();
    int round = 0;
    int fruit = 0;
    int taisai = 0;
    int evodd = 0;
    int dice1 = 0;
    int dice2 = 0;
    int dice3 = 0;
    int aa = 0;
    int bb = 0;
    int cc = 0;
    int dd = 0;
    int ee = 0;
    int rr = 0;
    int ss = 0;
    
    double dice_rate = 1.97;
    string[] fruit_name = { "apple","apple","lemon","watermelon","watermelon","luck","apple","orange","orange","bell","seven","seven","apple","lemon","lemon","star","star","luck","apple","bell","orange","bell","bar","bar"};
    int[] fruit_rate = { 5, 2, 10, 20, 2, 0, 5, 2, 10, 10, 2, 20, 5, 2, 10, 20, 2, 0, 5, 2, 10, 10, 25, 50 };
    int coin = 0;
    int remaintime = 120;
    int rdbuf = 0;

    protected void Page_Load(object sender, EventArgs e)
    {
        Random random = new Random();
        ss = random.Next(24) + 1;
        rr = random.Next(3) + 1;

        fruit = det_slot();
        if (fruit == 6 || fruit == 18)
        {
            aa = ss;
            if (aa == 6 || aa == 18)    aa += 1;
            if (aa > 24) aa = 1;
            bb = aa + 1;
            if (bb == 6 || bb == 18) bb += 1;
            if (bb > 24) bb = 1;
            cc = bb + 1;
            if (cc == 6 || cc == 18) cc += 1;
            if (cc > 24) cc = 1;
            
            if(rr == 1) { dd = 0; ee = 0; }
            if (rr == 2)
            {
                dd = cc + 1;
                if (dd == 6 || dd == 18) dd += 1;
                if (dd > 24) dd = 1;
                ee = 0;
            }
            if (rr == 3)
            {
                dd = cc + 1;
                if (dd == 6 || dd == 18) dd += 1;
                if (dd > 24) dd = 1;
                ee = dd + 1;
                if (ee == 6 || ee == 18) ee += 1;
                if (ee > 24) ee = 1;
            }
        }
        dice1 = random.Next(6) + 1;
        dice2 = random.Next(6) + 1;
        dice3 = random.Next(6) + 1;

        if ((dice1 + dice2 + dice3) > 10) { taisai = 1; }
        else taisai = 0;
        if ((dice1 + dice2 + dice3) % 2 != 0) { evodd = 1; }
        else evodd = 0;    
    }

    protected void Timer1_Tick(object sender, EventArgs e)
    {
        // 지정된 시간마다 현재 이벤트 핸들러 실행
        this.Label1.Text = DateTime.Now.ToLongTimeString();
        remaintime = 120 - (DateTime.Now.Hour * 3600 + DateTime.Now.Minute * 60 + DateTime.Now.Second) % 120;
        int dday = (DateTime.Now.Year-2000)*10000 + DateTime.Now.Month*100 + DateTime.Now.Day;
        round =  (DateTime.Now.Hour * 3600 + DateTime.Now.Minute * 60 + DateTime.Now.Second) / 120 + 1;
        round = dday*1000 + round;

        TextBox7.Text = remaintime.ToString();
        TextBox5.Text = round.ToString();
        if (remaintime == 20)
        {
            rdbuf = Convert.ToInt32(TextBox8.Text);            
            if (rdbuf != round)
            {
                DefineResult();
                rdbuf = round;                
            }
        }
    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        fruit = Convert.ToInt32(TextBox1.Text);
        dice1 = Convert.ToInt32(TextBox2.Text);
        dice2 = Convert.ToInt32(TextBox3.Text);
        dice3 = Convert.ToInt32(TextBox4.Text);

        if (fruit == 6 || fruit == 18)
        {
            aa = ss;
            if (aa == 6 || aa == 18) aa += 1;
            if (aa > 24) aa = 1;
            bb = aa + 1;
            if (bb == 6 || bb == 18) bb += 1;
            if (bb > 24) bb = 1;
            cc = bb + 1;
            if (cc == 6 || cc == 18) cc += 1;
            if (cc > 24) cc = 1;

            if (rr == 1) { dd = 0; ee = 0; }
            if (rr == 2)
            {
                dd = cc + 1;
                if (dd == 6 || dd == 18) dd += 1;
                if (dd > 24) dd = 1;
                ee = 0;
            }
            if (rr == 3)
            {
                dd = cc + 1;
                if (dd == 6 || dd == 18) dd += 1;
                if (dd > 24) dd = 1;
                ee = dd + 1;
                if (ee == 6 || ee == 18) ee += 1;
                if (ee > 24) ee = 1;
            }
        }

        if ((dice1 + dice2 + dice3) > 10) { taisai = 1; }
        else taisai = 0;
        if ((dice1 + dice2 + dice3) % 2 != 0) { evodd = 1; }
        else evodd = 0;

        round = Convert.ToInt32(this.TextBox5.Text);
        rdbuf = Convert.ToInt32(TextBox8.Text);
        if (rdbuf != round)
        {            
            rdbuf = round;
            TextBox8.Text = rdbuf.ToString();
            string sql = "insert into bettinglist2(round,fruit,taisai,evodd,dice1,dice2,dice3,aa,bb,cc,dd,ee) values (" + round + ", " + fruit + ", " + taisai + ", " + evodd + ", " + dice1 + ", " + dice2 + ", " + dice3 + ", " + aa + ", " + bb + ", " + cc + ", " + dd + ", " + ee + ")";
            mconn.Execute(sql);

            mconn.open();
            sql = "select user_id,round,bet_coin,bar,seven,star,watermelon,bell,lemon,orange,apple,doub,singl,big,small from betting2 where round = " + round + " ";
            MySqlDataReader reader = mconn.GetReader(sql);
            TextBox6.Text = "";
            while (reader.Read())
            {
                int userid = Convert.ToInt32(reader["user_id"].ToString());
                if (fruit != 6 && fruit!=18)
                {
                    coin = Convert.ToInt32(reader[fruit_name[fruit - 1]].ToString()) * fruit_rate[fruit - 1];
                }
                if(fruit==6 || fruit==18)
                {
                    coin = Convert.ToInt32(reader[fruit_name[aa - 1]].ToString()) * fruit_rate[aa - 1];
                    coin += Convert.ToInt32(reader[fruit_name[bb - 1]].ToString()) * fruit_rate[bb - 1];
                    coin += Convert.ToInt32(reader[fruit_name[cc - 1]].ToString()) * fruit_rate[cc - 1];
                    if(dd != 0) coin += Convert.ToInt32(reader[fruit_name[dd - 1]].ToString()) * fruit_rate[dd - 1];
                    if(ee != 0) coin += Convert.ToInt32(reader[fruit_name[ee - 1]].ToString()) * fruit_rate[ee - 1];
                }
                double buf = 0;
                if (taisai == 0) { buf += Convert.ToInt32(reader["small"].ToString()) * dice_rate; }
                else { buf += Convert.ToInt32(reader["big"].ToString()) * dice_rate; }

                if (evodd == 0) { buf += Convert.ToInt32(reader["doub"].ToString()) * dice_rate; }
                else { buf += Convert.ToInt32(reader["singl"].ToString()) * dice_rate; }

                coin += Convert.ToInt32(buf) - Convert.ToInt32(reader["bet_coin"].ToString());

                sql = "update betting2 set coin = " + coin + " where round=" + round + " and user_id =" + userid + "";
                mconn1.Execute(sql);

                TextBox6.Text += coin.ToString() + ",";

            }

            reader.Close();
            mconn.close();
        }
    }

    protected void DefineResult()
    {
        string sql = "insert into bettinglist2(round,fruit,taisai,evodd,dice1,dice2,dice3,aa,bb,cc,dd,ee) values (" + round + ", " + fruit + ", " + taisai + ", " + evodd + ", " + dice1 + ", " + dice2 + ", " + dice3 + ", " + aa + ", " + bb + ", " + cc + ", " + dd + ", " + ee + ")";
        mconn.Execute(sql);

        mconn.open();
        sql = "select user_id,round,bet_coin,bar,seven,star,watermelon,bell,lemon,orange,apple,doub,singl,big,small from betting2 where round = " + round + " ";
        MySqlDataReader reader = mconn.GetReader(sql);
        TextBox6.Text = "";
        while (reader.Read())
        {
            int userid = Convert.ToInt32(reader["user_id"].ToString());
            if (fruit != 6 && fruit!=18)
            {
                coin = Convert.ToInt32(reader[fruit_name[fruit - 1]].ToString()) * fruit_rate[fruit - 1];
            }
            if (fruit == 6 || fruit == 18)
            {
                coin = Convert.ToInt32(reader[fruit_name[aa - 1]].ToString()) * fruit_rate[aa - 1];
                coin += Convert.ToInt32(reader[fruit_name[bb - 1]].ToString()) * fruit_rate[bb - 1];
                coin += Convert.ToInt32(reader[fruit_name[cc - 1]].ToString()) * fruit_rate[cc - 1];
                if(dd!=0) coin += Convert.ToInt32(reader[fruit_name[dd - 1]].ToString()) * fruit_rate[dd - 1];
                if (ee != 0) coin += Convert.ToInt32(reader[fruit_name[ee - 1]].ToString()) * fruit_rate[ee - 1];
            }
            double buf = 0;
            if (taisai == 0) { buf += Convert.ToInt32(reader["small"].ToString()) * dice_rate; }
            else { buf += Convert.ToInt32(reader["big"].ToString()) * dice_rate; }

            if (evodd == 0) { buf += Convert.ToInt32(reader["doub"].ToString()) * dice_rate; }
            else { buf += Convert.ToInt32(reader["singl"].ToString()) * dice_rate; }

            coin += Convert.ToInt32(buf) - Convert.ToInt32(reader["bet_coin"].ToString());

            sql = "update betting2 set coin = " + coin + " where round=" + round + " and user_id =" + userid + "";
            mconn1.Execute(sql);

            TextBox6.Text += coin.ToString() + ",";

        }

        reader.Close();
        mconn.close();
        TextBox8.Text = round.ToString();
        TextBox9.Text = fruit.ToString();
        TextBox10.Text = dice1.ToString();
        TextBox11.Text = dice2.ToString();
        TextBox12.Text = dice3.ToString();
    }


    protected int det_slot()
    {
        Random random = new Random();
        int r = random.Next(100) + 1;
        int b = 1;
        if (r == 100)
        {
            //大Bar 1/100
            b = 24;
        }
        else if (r > 97)
        {
            //小Bar 2/100
            b = 23;
        }
        else if (r >= 95 && r <= 97)
        {
            //大77 3/100
            b = 12;
        }
        else if (r >= 90 && r <= 94)
        {
            //大星星 5/100
            b = 16;
        }
        else if (r >= 84 && r <= 89)
        {
            //大西瓜  6/100 수박
            b = 4;
        }
        else if (r >= 76 && r <= 83)
        {
            //大铃铛  8/100  큰종
            int ar = random.Next(2) + 1;
            switch (ar)
            {
                case 1:
                    b = 22;
                    break;
                case 2:
                    b = 10;
                    break;
            }
        }
        else if (r >= 68 && r <= 75)
        {
            //大椰子1  8/100  코코넛
            int ar = random.Next(2) + 1;
            switch (ar)
            {
                case 1:
                    b = 3;
                    break;
                case 2:
                    b = 15;
                    break;
            }
        }
        else if (r >= 59 && r <= 68)
        {
            //大桔子1  10/100  오렌지
            int ar = random.Next(2) + 1;
            switch (ar)
            {
                case 1:
                    b = 21;
                    break;
                case 2:
                    b = 9;
                    break;
            }
        }
        else if (r >= 44 && r <= 58)
        {
            //苹果  15/100   사과
            int ar = random.Next(4) + 1;
            switch (ar)
            {
                case 1:
                    b = 1;
                    break;
                case 2:
                    b = 7;
                    break;
                case 3:
                    b = 13;
                    break;
                case 4:
                    b = 19;
                    break;
            }
        }
        else if (r >= 36 && r <= 43)
        {
            //CHA  8/100
            int ar = random.Next(2) + 1;
            switch (ar)
            {
                case 1:
                    b = 6;
                    break;
                case 2:
                    b = 18;
                    break;
            }
        }
        else
        {
            //小东西   small
            int ar = random.Next(7) + 1;
            switch (ar)
            {
                case 1:
                    b = 2;
                    break;
                case 2:
                    b = 5;
                    break;
                case 3:
                    b = 8;
                    break;
                case 4:
                    b = 11;
                    break;
                case 5:
                    b = 14;
                    break;
                case 6:
                    b = 17;
                    break;
                case 7:
                    b = 20;
                    break;
            }
        }
        return b;
    }   
        
    
}