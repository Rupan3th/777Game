<%@ WebHandler Language="C#" Class="loginstate" %>

using System;
using System.Web;


public class loginstate : IHttpHandler {
    mysql mconn = new mysql();
    mysql mconn1 = new mysql();
    public void ProcessRequest (HttpContext context) {

        // INSERT INTO students (NAME, email) VALUES ('saltfactory', 'saltfactory@gmail.com')
        // ON DUPLICATE KEY UPDATE name='saltfactory', email='saltfactory@me.com'        
       
        String sql = "";
        if (context.Request["user_id"] != null)
        {
            int user_id = Convert.ToInt32(context.Request["user_id"]);
            sql = "INSERT INTO login2 (uid) VALUES (" + user_id + ") ON DUPLICATE KEY UPDATE cnt=cnt+" + 1 + " ";
            mconn.Execute(sql);

            if (context.Request["loginfir"] != null)
            {
                sql = "select logintime from login2 where uid="+ user_id +"";
                string logtimevalue = "";
                mconn1.GetValue(sql, out logtimevalue);
                DateTime dt = DateTime.Parse(logtimevalue);
                logtimevalue = dt.ToString("yyyy-MM-dd HH:mm:ss");

                sql = "INSERT INTO loginhistory (uid) VALUES (" + user_id + ") ;";
                sql += "update user set logtime = '"+logtimevalue+"'  where id=" + user_id + " ";
                mconn.Execute(sql);
            }
        }
    }

    public bool IsReusable {
        get {
            return false;
        }
    }

}